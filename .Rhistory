library(shiny); runApp('Latest_Shinyapp.R')
library(shiny); runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
########################################################################################################################################
## Data sets
# OD data
setwd("C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro Data NCL/In Vitro Data Spreadsheets")
od_data_all <- read.csv("All In vitro OD data July 2025.csv")
summary(od_data_all)
#############################################################################################################################################
#############################################################################################################################################
## Modelling for the treatment for t1516
od_data <- od_data_all %>%
filter(exp_id == 7,
strain == "t1516",
dox == 16) %>%
# time %in% seq(0, 24, 3)) %>%
group_by(time) %>%
summarise(mean_OD =  mean(OD, , na.rm = TRUE),
sd_OD = sd(OD, na.rm = TRUE),
n = n()) %>%
ungroup() %>%
select(time, mean_OD, sd_OD) %>%
rename(OD = mean_OD,
sd = sd_OD) %>%
mutate(sd = replace_na(sd, 0))
## Plot of the data
od_plot <- ggplot(od_data, aes(x = time, y = OD)) +
geom_point(size = 2) +
geom_errorbar(aes(ymin = OD - sd, ymax = OD + sd),
width = 0.2,
alpha = 0.7) +
labs(
x = "Time (hours)",
y = "OD (log10)"
) +
scale_x_continuous(limits = c(0, 24),
breaks = seq(0, 24, 3))+
scale_y_log10(
limits = c(0.001, 2),
minor_breaks = c(seq(1, 9, 1)*0.001, seq(1, 9, 1) * 0.01, seq(1, 9, 1) * 0.1, seq(1, 9) * 1, 2))+
theme_minimal()+
theme(
strip.text = element_text(size = 14),
axis.title = element_text(size = 16),
axis.text = element_text(size = 16),
axis.text.x = element_text(size = 14),
legend.title = element_text(size = 14),
legend.text = element_text(size = 14, vjust = 0.5)
)
##########################################################################################################################################
# Dead cell proportion data
dead_prop_data <- read.csv("Proportional Fungal death.csv")
summary(dead_prop_data)
dead_prop_data$dead_cell_pop <- signif(dead_prop_data$dead_cell_pop, 2)
library(gridExtra)
# Required libraries
library(deSolve)
library(FME)
library(dplyr)
library(ggplot2)
library(tidyr)
library(gridExtra)
# --- ODE Models ---
model1 <- function(time, state, pars) {
with(as.list(pars), {
P <- state["P"]
D <- state["D"]
dP = r * P * (1 - P / K) - kd * P
dD = kd * P
return(list(c(dP, dD)))
})
}
model2 <- function(time, state, pars) {
with(as.list(pars), {
Q <- state["Q"]
P <- state["P"]
D <- state["D"]
dQ = -kt * Q
dP = kt * Q + r * P * (1 - P / K) - kd * P
dD = kd * P
return(list(c(dQ, dP, dD)))
})
}
# --- Simulation function ---
sim_model <- function(OD0, pars, model_type) {
times <- seq(0, 24, by = 0.5)
if (model_type == "model1") {
ode_func <- model1
state <- c(P = OD0, D = 0)
} else if (model_type == "model2") {
ode_func <- model2
state <- c(Q = OD0, P = 0, D = 0)
} else {
stop("Invalid model_type")
}
out <- ode(y = state, times = times, func = ode_func, parms = pars)
out <- as.data.frame(out)
out$Q <- if (!"Q" %in% names(out)) 0 else out$Q
out$OD <- out$Q + out$P + out$D
out$dead <- out$D / out$OD
return(out)
}
# --- Model fitting ---
model_run <- function(od_df, df, model_type, pars) {
od_mat <- as.matrix(od_df[, c("time", "OD")])
death_mat <- as.matrix(df[, c("time", "dead")])
OD_0 <- od_df %>% slice(1) %>% pull(OD)
cost_fn <- function(pars) {
out <- sim_model(OD0 = OD_0, pars = pars, model_type = model_type)
cost <- modCost(model = out, obs = od_mat)
cost <- modCost(model = out, obs = death_mat, cost = cost)
return(cost)
}
cost_fn_log <- function(log_pars) {
pars <- exp(log_pars)
cost_fn(pars)
}
fit <- modFit(
f = cost_fn_log,
p = log(pars * 2)
)
fit_summary <- summary(fit)
log_pars <- coef(fit)
se_log <- sqrt(diag(fit_summary$cov.scaled))
lower_log <- log_pars - 1.96 * se_log
upper_log <- log_pars + 1.96 * se_log
ci_table <- data.frame(
parameter = names(log_pars),
fitted_value = exp(log_pars),
lower_95_CI = exp(lower_log),
upper_95_CI = exp(upper_log)
)
final_model <- sim_model(OD0 = OD_0, pars = exp(log_pars), model_type = model_type)
obs_pred_data <- data.frame(od_mat) %>%
left_join(final_model, by = "time", suffix = c("", "_pred"))
set.seed(42)
mcmc <- modMCMC(
f = cost_fn_log,
p = log_pars,
jump = fit_summary$cov.scaled * 2.4^2 / length(log_pars),
var0 = fit$var_ms_unweighted,
burninlength = 50,
updatecov = 50,
niter = 500
)
# mcmc_plot <- plot(mcmc, Full = TRUE)
sR <- sensRange(
func = function(pars) sim_model(OD0 = OD_0, pars = pars, model_type = model_type),
parms = exp(fit$par),
parInput = exp(mcmc$par)
)
# sR_plot <- plot(summary(sR), xlab = "time")
Sfun <- sensFun(func = cost_fn, parms = pars)
# sens_plot <- plot(Sfun, which = c("OD", "dead"), xlab="time", lwd = 2)
ident <- collin(Sfun)
list(
Sfun = Sfun,
collinearity = ident,
fit = fit_summary,
ci_table = ci_table,
obs_pred_data = obs_pred_data,
mcmc = mcmc,
sR = sR
)
}
# Dummy data for test
od_df <- od_data
df <- death_data
#############################################################################################################################################
#############################################################################################################################################
## Modelling for the treatment for t1516
od_data <- od_data_all %>%
filter(exp_id == 7,
strain == "t1516",
dox == 16) %>%
# time %in% seq(0, 24, 3)) %>%
group_by(time) %>%
summarise(mean_OD =  mean(OD, , na.rm = TRUE),
sd_OD = sd(OD, na.rm = TRUE),
n = n()) %>%
ungroup() %>%
select(time, mean_OD, sd_OD) %>%
rename(OD = mean_OD,
sd = sd_OD) %>%
mutate(sd = replace_na(sd, 0))
dead_prop_data$dead_cell_pop <- signif(dead_prop_data$dead_cell_pop, 2)
death_data <- dead_prop_data %>%
filter(dox == 64) %>%
rename(dead = dead_cell_pop) %>%
select(time, dead)
# Dummy data for test
od_df <- od_data
df <- death_data
# Initial parameters
model_type <- "model1"
model_params <- c(r = 0.4, K = 0.95, kd = 0.2)
# Run the model
res <- model_run(od_df = od_df, df = df, model_type = model_type, pars = model_params)
# --- Model fitting ---
model_run <- function(od_df, df, model_type, pars) {
od_mat <- as.matrix(od_df[, c("time", "OD")])
death_mat <- as.matrix(df[, c("time", "dead")])
OD_0 <- od_df %>% slice(1) %>% pull(OD)
cost_fn <- function(pars) {
out <- sim_model(OD0 = OD_0, pars = pars, model_type = model_type)
cost <- modCost(model = out, obs = od_mat)
cost <- modCost(model = out, obs = death_mat, cost = cost)
return(cost)
}
cost_fn_log <- function(log_pars) {
pars <- exp(log_pars)
cost_fn(pars)
}
fit <- modFit(
f = cost_fn_log,
p = log(pars * 2)
)
fit_summary <- summary(fit)
log_pars <- coef(fit)
se_log <- sqrt(diag(fit_summary$cov.scaled))
lower_log <- log_pars - 1.96 * se_log
upper_log <- log_pars + 1.96 * se_log
ci_table <- data.frame(
parameter = names(log_pars),
fitted_value = exp(log_pars),
lower_95_CI = exp(lower_log),
upper_95_CI = exp(upper_log)
)
final_model <- sim_model(OD0 = OD_0, pars = exp(log_pars), model_type = model_type)
obs_pred_data <- data.frame(od_mat) %>%
left_join(final_model, by = "time", suffix = c("", "_pred"))
set.seed(42)
mcmc <- modMCMC(
f = cost_fn_log,
p = log_pars,
jump = fit_summary$cov.scaled * 2.4^2 / length(log_pars),
var0 = fit$var_ms_unweighted,
burninlength = 50,
updatecov = 50,
niter = 500
)
# mcmc_plot <- plot(mcmc, Full = TRUE)
sR <- sensRange(
func = function(pars) sim_model(OD0 = OD_0, pars = pars, model_type = model_type),
parms = exp(fit$par),
parInput = exp(mcmc$par)
)
sR <- summary(sR)
Sfun <- sensFun(func = cost_fn, parms = pars)
# sens_plot <- plot(Sfun, which = c("OD", "dead"), xlab="time", lwd = 2)
ident <- collin(Sfun)
list(
Sfun = Sfun,
collinearity = ident,
fit = fit_summary,
ci_table = ci_table,
obs_pred_data = obs_pred_data,
mcmc = mcmc,
sR = sR
)
}
# Dummy data for test
od_df <- od_data
df <- death_data
# Initial parameters
model_type <- "model1"
model_params <- c(r = 0.4, K = 0.95, kd = 0.2)
# Run the model
res <- model_run(od_df = od_df, df = df, model_type = model_type, pars = model_params)
# Check CI table
print(res$ci_table)
# Sense Range
plot(sR)
# Sense Range
plot(res$sR)
# Sense Range
plot(res$sR, xlab = "time")
# Sense Range
plot(res$sR, main = "fg", xlab = "Time")
# Sense Range
plot(res$sR, sub = "fg", xlab = "Time")
# Sense Range
plot(res$sR[c(4,5)], sub = "fg", xlab = "Time")
res$sR
library(shiny); runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
plot(res$sR, sub = paste("Conc:", name), xlab = "Time", ylab = "Model Output")
plot(res$sR, xlab = "Time", ylab = "Model Output")
grid::grid.grabExpr(
plot(res$sR, xlab = "Time", ylab = "Model Output")
)
plot(Sfun)
plot(res$Sfun)
plot(res$Sfun, which = c("OD", "dead"), xlab="time", lwd = 2)
plot(res$Sfun, which = c("OD", "dead"), xlab = "time", lwd = 2, legend.pos = "topright")
plot(res$Sfun, which = c("OD", "dead"), xlab = "time", lwd = 2, legend.pos = "topright")
?plot.sensFun
plot(res$Sfun, which = c("OD", "dead"), xlab = "time", lwd = 2, legpos = "topright")
plot(res$Sfun, which = c("OD", "dead"), xlab = "time", lwd = 2, legpos = "topleft")
runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
library(shiny); runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
runApp('Latest_Shinyapp.R')
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod2",
nout = 3,
outnames = c("Q" ,"P", "D"),
atol = 1e-3,
rtol = 1e-6
)
library(deSolve)
# Parameters vector including all four parameters: r, K, kd
parms <- c(r = 0.4, K = 1, kd = 0.02)
parms <- c(r = 0.4, K = 1, kd = 0.02, kt = 0.05)
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod2",
nout = 3,
outnames = c("Q" ,"P", "D"),
atol = 1e-3,
rtol = 1e-6
)
y0 <- c(0.05, 0, 0)
parms <- c(r = 0.4, K = 1, kd = 0.02, kt = 0.05)
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod2",
nout = 3,
outnames = c("Q" ,"P", "D"),
atol = 1e-3,
rtol = 1e-6
)
times <- seq(0, 24, by = 0.5)
y0 <- c(0.05, 0, 0)
parms <- c(r = 0.4, K = 1, kd = 0.02, kt = 0.05)
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod2",
nout = 3,
outnames = c("Q" ,"P", "D"),
atol = 1e-3,
rtol = 1e-6
)
getwd()
### Compilation into .Fortran
## Set the wd
setwd("C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/Programming and Data Analysis UoL/Fortran Magic/Trr1 Model - Both models")
## Loading the Fortran file into R space
system("R CMD SHLIB mod1.f90")
# Load the shared library compiled from mod2.f90
dyn.load("mod1.dll")
# Verifying subroutine
is.loaded("derivscal_")
library(deSolve)
# Parameters vector including all four parameters: r, K, kd
parms <- c(r = 0.4, K = 1, kd = 0.02)
.Fortran("initcal", as.double(parms))
# Initial conditions
y0 <- c(0.05, 0)
times <- seq(0, 24, by = 0.5)
# Run the ODE solver
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod1",
nout = 2,
outnames = c("P", "D"),
atol = 1e-3,
rtol = 1e-6
)
head(out)
# Run the ODE solver
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod1",
nout = 2,
# outnames = c("P", "D"),
atol = 1e-3,
rtol = 1e-6
)
head(out)
# Run the ODE solver
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod1",
# nout = 2,
# outnames = c("P", "D"),
atol = 1e-3,
rtol = 1e-6
)
head(out)
times <- seq(0, 24, by = 0.5)
y0 <- c(0.05, 0, 0)
parms <- c(r = 0.4, K = 1, kd = 0.02, kt = 0.05)
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod2",
nout = 3,
outnames = c("Q" ,"P", "D"),
atol = 1e-3,
rtol = 1e-6
)
system("R CMD SHLIB mod2.f90")
# Load the shared library compiled from mod2.f90
dyn.load("mod2.dll")
times <- seq(0, 24, by = 0.5)
y0 <- c(0.05, 0, 0)
parms <- c(r = 0.4, K = 1, kd = 0.02, kt = 0.05)
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod2",
nout = 3,
outnames = c("Q" ,"P", "D"),
atol = 1e-3,
rtol = 1e-6
)
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod2",
# nout = 3,
# outnames = c("Q" ,"P", "D"),
atol = 1e-3,
rtol = 1e-6
)
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod2"
# nout = 3,
# outnames = c("Q" ,"P", "D"),
# atol = 1e-3,
# rtol = 1e-6
)
head(out)
out <- ode(
y = y0,
times = times,
func = "derivscal",
initcfunc = "initcal",
parms = NULL,
dllname = "mod2",
nout = 3,
outnames = c("Q", "P", "D"),
rtol = 1e-3,
atol = 1e-6
)
library(shiny); runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
runApp('C:/Users/ibanda/OneDrive - The University of Liverpool/Attachments/TRR1 Project/UoL Secondary Supervision/R and data files for the runs In vitro Assays/In vitro R files/Latest_Shinyapp.R')
